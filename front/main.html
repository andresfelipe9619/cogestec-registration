<script type="text/babel">
  $(document).ready(init_js);
  var buttonpressed = undefined;
  var personIndex = -1;
  var currentPerson = null;
  var requestPayload = null;
  var radioPressed = undefined;

  function init_js() {
    $(".submit.button").click(function() {
      buttonpressed = $(this).attr("name");
    });

    // $(".ui.radio.checkbox").checkbox();
    // $(".ui.radio.checkbox").checkbox({
    //   onChecked: function() {
    //     radioPressed = $(this).attr("value");
    //     console.log("radio", radioPressed);
    //     if (currentPerson) {
    //       handleRadioChange(radioPressed);
    //     }
    //   }
    // });
    formValidation();

    $(".ui.modal").modal();
    $(".ui.modal").modal("setting", "closable", false);

    $(".numeric").on("keypress", function(e) {
      return (
        e.metaKey || // cmd/ctrl
        e.which <= 0 || // arrow keys
        e.which == 8 || // delete key
        /[0-9]/.test(String.fromCharCode(e.which))
      ); // numbers
    });

    $("#busca-cedula").on("keyup", function(event) {
      event.preventDefault();
      // Number 13 is the "Enter" key on the keyboard
      if (event.keyCode === 13) {
        // Trigger the button element with a click
        document.getElementById("btn-search").click();
      }
    });
  }

  function validateDate() {
    var someDate = new Date("6 Dec 2011").toDateString();
    var today = new Date().toDateString();
    var datesAreSame = today === someDate;
  }

  function validationpassed(e) {
    try {
      e.preventDefault();
      var mForm = $("#form-form");
      var formData = mForm.serializeArray();
      mForm.addClass("loading");
      if (!radioPressed) {
        formData.push({ name: "acepta_ponencia", value: "-" });
      }

      if (!$(".file-field").hasClass("not-visible")) {
        var file = $('input[type="file"]').prop("files")[0];
        var reader = new FileReader();
        reader.readAsDataURL(file);

        reader.onloadend = function(e) {
          function onSuccess(result) {
            if (result) {
              formData.push({ name: "doc_file", value: result.url });
              addPayment(formData);
            }
          }

          google.script.run
            .withSuccessHandler(onSuccess)
            .createPersonFolder(
              $("input[name='cedula']").val(),
              e.target.result
            );
        };
      } else {
        formData.push({ name: "doc_file", value: "Professional" });
        addPayment(formData);
      }
    } catch (error) {
      $(".ui.error.message").text(error.toString());
    }
  }

  function addPayment(formData) {
    formData.push({ name: "documento_verificado", value: "-" });
    console.log("form", formData);
    registerPersonInSheet(formData);
  }

  function registerPersonInSheet(formData) {
    function onSuccess(response) {
      console.log("register response", response);

      if (response.ok) {
        console.log(buttonpressed);
        if (String(buttonpressed).includes("submit-btn")) {
          showPersonInModal(response.data);
        } else {
          showDiscountModal();
        }
      } else {
        console.log("You fucked up", response);
      }
    }
    console.log(formData);
    google.script.run.withSuccessHandler(onSuccess).registerPerson(formData);
  }

  function getRequestPayload() {
    google.script.url.getLocation(function(location) {
      var payload = location.parameter.attendant || null;
      setAttendantPayment(payload);
    });
  }

  function setAttendantPayment(attendant) {
    var he_pays = 0;
    var concept = "";
    if (attendant) {
      switch (attendant) {
        case "professional":
          he_pays = "437.000";
          concept = "Professional Attendant";
          $(".file-field").addClass("not-visible");
          $("#ponencia_fields").addClass("not-visible");
          break;

        case "professional_r":
          he_pays = "322.000";
          concept = "Professional Researcher";
          $(".file-field").addClass("not-visible");
          break;

        case "student":
          he_pays = "287.500";
          concept = "Student";
          $("#ponencia_fields").addClass("not-visible");
          $("#submit-btn").addClass("not-visible");
          $("#free-btn").removeClass("not-visible");
          break;

        case "student_r":
          he_pays = "230.000";
          concept = "Student Researcher";
          $("#submit-btn").addClass("not-visible");
          $("#free-btn").removeClass("not-visible");
          break;

        default:
          break;
      }
      requestPayload = he_pays;
      $("input[name='concepto_pago']").val(concept);
      $("input[name='concepto_pago']").prop("readonly", true);
      $("input[name='concepto_pago']").addClass("not-allowed");
      $("input[name='pago_total']").val(requestPayload);
      $("input[name='pago_total']").prop("readonly", true);
      $("input[name='pago_total']").addClass("not-allowed");
    }
  }
  function handleRadioChange(radio) {
    $("#msg-change").removeClass("not-visible");
  }

  function searchForPerson() {
    hideForm();
    $("#btn-search").addClass("loading");

    var onSuccess = function(result) {
      var person = JSON.parse(result);
      if (person) {
        showForm();
        $("#form-form").addClass("loading");
        console.log("A nice formatted person", person);
        $("#btn-search").removeClass("loading");
        $("input[name='cedula']").prop("readonly", true);
        $("input[name='cedula']").addClass("not-allowed");
        if (person.isRegistered) {
          showPersonInForm(person);
        } else {
          getRequestPayload();
          $("#form-form").removeClass("loading");
        }
      } else {
        console.log("Something went wrong searching user...");
      }
    };

    var cedula = $("#busca-cedula").val();
    if (cedula.length > 0) {
      google.script.run.withSuccessHandler(onSuccess).searchPerson(cedula);
    } else {
      $("#btn-search").removeClass("loading");
      $("#search-msg").html("Por favor ingrese una cedula");
      $("#search-msg").css("display", "block");
      setTimeout(function() {
        $("#search-msg").html("Por favor ingrese una cedula");
        $("#search-msg").css("display", "none");
      }, 3000);
    }
  }

  function disableFormFielfds(bool) {
    if (bool) {
      $("input:not([name='busca-cedula'])").prop("readonly", true);
      $("input:not([name='busca-cedula'])").addClass("not-allowed");
    } else {
      $("input:not([name='busca-cedula'])").prop("readonly", false);
      $("input:not([name='busca-cedula'])").removeClass("not-allowed");
    }
  }
  var normalize = (function() {
    var from = "ÃÀÁÄÂÈÉËÊÌÍÏÎÒÓÖÔÙÚÜÛãàáäâèéëêìíïîòóöôùúüûÑñÇç",
      to = "AAAAAEEEEIIIIOOOOUUUUaaaaaeeeeiiiioooouuuuÑñcc",
      mapping = {};

    for (var i = 0, j = from.length; i < j; i++)
      mapping[from.charAt(i)] = to.charAt(i);

    return function(str) {
      var ret = [];
      for (var i = 0, j = str.length; i < j; i++) {
        var c = str.charAt(i);
        if (mapping.hasOwnProperty(str.charAt(i))) ret.push(mapping[c]);
        else ret.push(c);
      }
      return ret.join("");
    };
  })();

  function showPersonInForm(person) {
    loadPersonInForm(person);

    if (person.data["pago_comprobado"] == "SI") {
      showPaymentApproved();
    } else {
      showPaymentDisapproved(person);
    }

    $(".file-field").addClass("not-visible");
    $("#politicas").addClass("not-visible");
    $("#submit-btn").addClass("not-visible");
    $("#submit-pay-btn").addClass("not-visible");

    disableFormFielfds(true);
    $("#form-form").removeClass("loading");
  }

  function loadPersonInForm(person) {
    console.log("Person in form", person);
    personIndex = Number(person.index) + 1;
    currentPerson = person.data;
    $("input[name='nombres']").val(person.data.nombres);
    $("input[name='apellidos']").val(person.data.apellidos);
    $("input[name='cedula']").val(person.data.cedula);
    $("input[name='correo']").val(person.data.correo);
    $("input[name='telefono']").val(person.data.telefono);
    $("input[name='dependencia']").val(person.data.dependencia);
    $("input[name='concepto_pago']").val(person.data.concepto_pago);
    $("input[name='pago_total']").val(person.data.pago_total);
    // $(".ui.radio").checkbox();

    // if (person.data["acepta_ponencia"] == "SI") {
    //   $("input[id='ponencia_si']").checkbox("check");
    // } else if (person.data["acepta_ponencia"] == "NO") {
    //   $("input[id='ponencia_no']").checkbox("check");
    // } else {
    //   $("#ponencia_fields").addClass("not-visible");
    // }
  }

  function showPaymentApproved(person) {
    $("#pay-msg").removeClass("not-visible");
    $("#pay-msg").removeClass("warning");
    $("#pay-msg").addClass("success");
    $("#pay-msg").html(`<i class="icon check circle"></i>
                El pago de su inscripción registrado satisfactoriamente.
              </div>`);
  }

  function showPaymentDisapproved(person) {
    $("#pay-msg").removeClass("not-visible");
    $("#pay-msg").removeClass("success");
    $("#pay-msg").addClass("warning");
    $("#pay-msg").html(`<i class="icon warning "></i>
                El pago de su inscripción aun no ha sido registrado.
                Usted ha sido registrado como ${person.data.concepto_pago}
              </div>`);
    $("#register-pay-btn").removeClass("not-visible");
    $("#register-pay-btn").addClass("visible");
  }

  function modalPayment() {
    var onSuccess = function(person) {
      if (person) {
        if (person.isRegistered) {
          personIndex = Number(person.index) + 1;
          if (personIndex > -1) {
            function fullSuccess(result) {
              console.log("result", result);
              $("#modal-payment").removeClass("loading");
              // $(".ui.modal").modal("hide");
              hideForm();
              return true;
            }
            return google.script.run
              .withSuccessHandler(fullSuccess)
              .generatePayment(personIndex);
          }
        }
      } else {
        console.log("Something went wrong searching user...");
      }
    };

    var cedula = $("#busca-cedula").val();
    if (cedula.length > 0) {
      return google.script.run
        .withSuccessHandler(onSuccess)
        .searchPerson(cedula);
    }
  }

  function submitPayment() {
    $("#register-pay-btn").addClass("loading");

    if (currentPerson) {
      $("#register-pay-btn").removeClass("loading");
      showPersonInModal(currentPerson);
    }
  }

  function showForm() {
    $("#mainForm").css("display", "block");
    $("ui.submit.button").css("display", "block");
    $("input[name='cedula']").val($("#busca-cedula").val());
    disableFormFielfds(false);
  }

  function hideForm() {
    $("#mainForm").css("display", "none");
    $(".fields.regreso").removeClass("not-allowed");
    $(".file-field").removeClass("not-visible");
    $(".pay-field").removeClass("not-visible");
    $("#submit-btn").removeClass("not-visible");
    $("#submit-pay-btn").removeClass("not-visible");

    $(".fields.regreso").removeClass("not-allowed");
    $("#pay-msg").addClass("not-visible");
    $("#pay-msg").text("");

    disableFormFielfds(false);
    $("#form-form").form("clear");
  }

  function showPersonInModal(person) {
    $("#form-form").removeClass("loading");
    $("#result-msg").text("");
    $(".ui.modal").modal("show");
    $(".actions").css("display", "block");
    $("#modal-form").removeClass("not-visible");

    $("#result-msg").text(`
    Por favor, copie la información que mostramos a continuación 
    en el formulario de pago de inscripción (Botón azul).`);

    $("input[name$='_modal']").prop("readonly", true);
    // $("input[name$='_modal']").addClass("not-allowed");

    $("input[name='nombres_modal']").val(
      person.nombres + " " + person.apellidos
    );
    $("input[name='cedula_modal']").val(person.cedula);
    $("input[name='telefono_modal']").val(person.telefono);
    $("input[name='dependencia_modal']").val("COGESTEG 2019");
    $("input[name='concepto_pago_modal']").val(person.concepto_pago);
    $("input[name='pago_total_modal']").val(person.pago_total);
    $(".ui.modal").modal("refresh");
  }

  function showDiscountModal() {
    $("#form-form").removeClass("loading");
    $("#result-msg").text("");
    $(".ui.modal").modal("show");
    $("#modal-form").addClass("not-visible");
    $(".actions").css("display", "block");
    $("#result-msg").text(
      `Su solicitud para aplicar el descuento será estudiada y tendrá respuesta en un plazo máximo de tres días habiles vía correo electrónico, para que pueda proceder al pago de su inscripcion.`
    );
  }

  function formValidation() {
    $.fn.form.settings.rules.file = function(value) {
      if ($(this).hasClass("not-visible") || value.length > 0) {
        return true;
      }
      return false;
    };
    $.fn.form.settings.rules.file = function(value) {
      if ($(".file-field").hasClass("not-visible") || value.length > 0) {
        return true;
      }
      return false;
    };

    $.fn.form.settings.rules.mEmail = function(value) {
      var regex = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
      if (value.match(regex)) {
        return true;
      }
      return false;
    };
    $.fn.form.settings.rules.ponencia = function(value) {
      console.log("value ponencia", value);
      if ($("#ponencia_fields").hasClass("not-visible") || radioPressed) {
        return true;
      }
      return false;
    };
    $("#form-form").form({
      inline: true,
      on: "blur",
      transition: "fade down",
      onSuccess: validationpassed,
      fields: {
        nombres: {
          identifier: "nombres",
          rules: [
            {
              type: "empty",
              prompt: "Por favor ingrese un nombre"
            }
          ]
        },
        apellidos: {
          identifier: "apellidos",
          rules: [
            {
              type: "empty",
              prompt: "Por favor ingrese un apellido"
            }
          ]
        },
        dependencia: {
          identifier: "dependencia",
          rules: [
            {
              type: "empty",
              prompt: "Por favor ingrese un nombre"
            }
          ]
        },
        cedula: {
          identifier: "cedula",
          rules: [
            {
              type: "number",
              prompt: "Por favor ingrese una cedula valido"
            },
            {
              type: "empty",
              prompt: "Por favor ingrese una cedula"
            }
          ]
        },
        telefono: {
          identifier: "telefono",
          rules: [
            {
              type: "number",
              prompt: "Por favor ingrese un numero valido"
            },
            {
              type: "empty",
              prompt: "Por favor ingrese un numero"
            }
          ]
        },
        concepto_pago: {
          identifier: "concepto_pago",
          rules: [
            {
              type: "empty",
              prompt: "Por favor ingrese un numero"
            }
          ]
        },
        pago_total: {
          identifier: "pago_total",
          rules: [
            {
              type: "number",
              prompt: "Por favor ingrese un numero valido"
            },
            {
              type: "empty",
              prompt: "Por favor ingrese un numero"
            }
          ]
        },
        acepta_ponencia: {
          identifier: "acepta_ponencia",
          rules: [
            {
              type: "ponencia",
              prompt: "Por favor seleccione una de las dos opciones"
            }
          ]
        },
        politicas: {
          identifier: "politicas",
          rules: [
            {
              type: "checked",
              prompt: "Por favor acepte nuestras politicas para inscribirse"
            }
          ]
        },
        email: {
          identifier: "correo",
          rules: [
            {
              type: "mEmail",
              prompt: "Por favor ingrese a correo valido"
            },
            {
              type: "empty",
              prompt: "Por favor ingrese un correo"
            }
          ]
        },
        doc_file: {
          identifier: "doc_file",
          rules: [
            {
              type: "file",
              prompt: "Por favor ingrese un archivo"
            }
          ]
        },
        pay_file: {
          identifier: "pay_file",
          rules: [
            {
              type: "file",
              prompt: "Por favor ingrese un archivo"
            }
          ]
        }
      }
    });
  }
</script>
