<script type="text/babel">
  $(document).ready(init_js);
  var buttonpressed;
  var personIndex;
  var requestPayload;
  function init_js() {
    $(".submit.button").click(function() {
      buttonpressed = $(this).attr("name");
    });

    formValidation();

    $(".ui.modal").modal();
    $(".ui.modal").modal("setting", "closable", false);
    // $(".ui.modal").modal({
    //   blurring: true,
    //   centered: true

    // });
    // $('#submit-btn').on('click',)
    $(".numeric").on("keypress", function(e) {
      return (
        e.metaKey || // cmd/ctrl
        e.which <= 0 || // arrow keys
        e.which == 8 || // delete key
        /[0-9]/.test(String.fromCharCode(e.which))
      ); // numbers
    });

    $("#busca-cedula").on("keyup", function(event) {
      event.preventDefault();
      // Number 13 is the "Enter" key on the keyboard
      if (event.keyCode === 13) {
        // Trigger the button element with a click
        document.getElementById("btn-search").click();
      }
    });
  }

  function validationpassed(e) {
    try {
      e.preventDefault();
      var mForm = $(".ui.form");
      var formData = mForm.serializeArray();
      mForm.addClass("loading");

      if (!$(".file-field").hasClass("not-visible")) {
        var file = $('input[type="file"]').prop("files")[0];
        var reader = new FileReader();
        reader.readAsDataURL(file);

        reader.onloadend = function(e) {
          function onSuccess(result) {
            if (result) {
              formData.push({ name: "doc_file", value: result.url });
              addPayment(formData);
            }
          }

          google.script.run
            .withSuccessHandler(onSuccess)
            .createPersonFolder(
              $("input[name='cedula']").val(),
              e.target.result
            );
        };
      } else {
        formData.push({ name: "doc_file", value: "SRA" });
        addPayment(formData);
      }
    } catch (error) {
      $(".ui.error.message").text(error.toString());
    }
  }

  function addPayment(formData) {
    console.log("all is ok", buttonpressed);
    // if (buttonpressed == "submit-btn") {
    formData.push({ name: "pago_generado", value: "NO" });
    // }

    console.log("form", formData);
    registerPersonInSheet(formData);
  }

  function registerPersonInSheet(formData) {
    function onSuccess(response) {
      if (response.ok) {
        $(".ui.form").removeClass("loading");

        $("#result-msg").text("");
        $("#result-msg").text(
          "Su inscripción a fue realizada de manera exitosa."
        );
        $(".ui.modal").modal("show");
        $(".actions").css("display", "block");
      } else {
        console.log("You fucked up", response);
      }
    }
    console.log(formData);
    google.script.run.withSuccessHandler(onSuccess).registerPerson(formData);
  }

  function getRequestPayload() {
    google.script.url.getLocation(function(location) {
      var payload = location.parameter.attendant || null;
      setAttendantPayment(payload);
    });
  }

  function setAttendantPayment(attendant) {
    var he_pays = 0;
    if (attendant) {
      switch (attendant) {
        case "professional":
          he_pays = "437.000";
          $("input[name='doc_file']").addClass("not-visible");
          break;
        case "professional_r":
          he_pays = "322.000";
          $("input[name='doc_file']").addClass("not-visible");
          break;
        case "student":
          he_pays = "287.500";
          break;
        case "student_r":
          he_pays = "230.000";
          break;
        default:
          break;
      }
      requestPayload = he_pays;
      $("input[name='concepto_pago']").val(requestPayload);
      $("input[name='concepto_pago']").prop("readonly", true);
      $("input[name='concepto_pago']").addClass("not-allowed");
      $("input[name='pago_total']").val(requestPayload);
      $("input[name='pago_total']").prop("readonly", true);
      $("input[name='pago_total']").addClass("not-allowed");
    }
  }
  function searchForPerson() {
    hideForm();
    $("#btn-search").addClass("loading");

    var onSuccess = function(person) {
      if (person) {
        showForm();
        $(".ui.form").addClass("loading");
        console.log("A nice formatted person", person);
        $("#btn-search").removeClass("loading");
        $("input[name='cedula']").prop("readonly", true);
        $("input[name='cedula']").addClass("not-allowed");
        if (person.isRegistered) {
          loadPersonInForm(person);
        } else {
          getRequestPayload();
          $(".ui.form").removeClass("loading");
        }
      } else {
        console.log("Something went wrong searching user...");
      }
    };

    var cedula = $("#busca-cedula").val();
    if (cedula.length > 0) {
      google.script.run.withSuccessHandler(onSuccess).searchPerson(cedula);
    } else {
      $("#btn-search").removeClass("loading");
      $("#search-msg").html("Por favor ingrese una cedula");
      $("#search-msg").css("display", "block");
      setTimeout(function() {
        $("#search-msg").html("Por favor ingrese una cedula");
        $("#search-msg").css("display", "none");
      }, 3000);
    }
  }

  function disableFormFielfds(bool) {
    if (bool) {
      $("input:not([name='busca-cedula'])").prop("readonly", true);
      $("input:not([name='busca-cedula'])").addClass("not-allowed");
    } else {
      $("input:not([name='busca-cedula'])").prop("readonly", false);
      $("input:not([name='busca-cedula'])").removeClass("not-allowed");
    }
  }
  var normalize = (function() {
    var from = "ÃÀÁÄÂÈÉËÊÌÍÏÎÒÓÖÔÙÚÜÛãàáäâèéëêìíïîòóöôùúüûÑñÇç",
      to = "AAAAAEEEEIIIIOOOOUUUUaaaaaeeeeiiiioooouuuuÑñcc",
      mapping = {};

    for (var i = 0, j = from.length; i < j; i++)
      mapping[from.charAt(i)] = to.charAt(i);

    return function(str) {
      var ret = [];
      for (var i = 0, j = str.length; i < j; i++) {
        var c = str.charAt(i);
        if (mapping.hasOwnProperty(str.charAt(i))) ret.push(mapping[c]);
        else ret.push(c);
      }
      return ret.join("");
    };
  })();

  function loadPersonInForm(person) {
    console.log("Person in form", person);
    personIndex = Number(person.index) + 1;
    $("input[name='nombres']").val(person.data.nombres);
    $("input[name='apellidos']").val(person.data.apellidos);
    $("input[name='cedula']").val(person.data.cedula);
    $("input[name='correo']").val(person.data.correo);
    $("input[name='telefono']").val(person.data.telefono);
    $("input[name='concepto_pago']").val(person.data.concepto_pago);
    $("input[name='pago_total']").val(person.data.pago_total);
    if (person.data["pago_comprobado"] == "SI") {
      $("#pay-msg").removeClass("not-visible");
      $("#pay-msg").removeClass("warning");
      $("#pay-msg").addClass("success");
      $("#pay-msg").append(`<i class="icon check circle"></i>
                                  El pago de su inscripción a la Noche de Gala de Egresados fue registrado satisfactoriamente.
                                </div>`);
    } else {
      $("#pay-msg").removeClass("not-visible");
      $("#pay-msg").removeClass("success");
      $("#pay-msg").addClass("warning");

      $("#pay-msg").append(`<i class="icon warning "></i>
                                  El pago de su inscripción aun no ha sido registrado.
                                </div>`);
    }

    $("#submit-btn").addClass("not-visible");
    $("#submit-pay-btn").addClass("not-visible");

    if (person.data["pago_generado"] == "NO") {
      $("#register-pay-btn").removeClass("not-visible");
      $("#register-pay-btn").addClass("visible");
    }
    disableFormFielfds(true);
    $(".ui.form").removeClass("loading");
  }

  function modalPayment() {
    var onSuccess = function(person) {
      if (person) {
        if (person.isRegistered) {
          personIndex = Number(person.index) + 1;
          if (personIndex > -1) {
            function fullSuccess(result) {
              console.log("result", result);
              $("#modal-payment").removeClass("loading");
              $(".ui.modal").modal("hide");
              hideForm();
              return true;
            }
            return google.script.run
              .withSuccessHandler(fullSuccess)
              .generatePayment(personIndex);
          }
        }
      } else {
        console.log("Something went wrong searching user...");
      }
    };

    var cedula = $("#busca-cedula").val();
    $("#modal-payment").addClass("loading");
    if (cedula.length > 0) {
      return google.script.run
        .withSuccessHandler(onSuccess)
        .searchPerson(cedula);
    }
  }

  function submitPayment() {
    $("#register-pay-btn").addClass("loading");

    if (personIndex > -1) {
      function onSuccess(result) {
        $("#register-pay-btn").removeClass("loading");
        if (result) {
          console.log("result", result);
          hideForm();
          return true;
        }
      }
      return google.script.run
        .withSuccessHandler(onSuccess)
        .generatePayment(personIndex);
    }
  }

  function showForm() {
    $("#mainForm").css("display", "block");
    $("ui.submit.button").css("display", "block");
    $("input[name='cedula']").val($("#busca-cedula").val());
    disableFormFielfds(false);
  }

  function hideForm() {
    $("#mainForm").css("display", "none");
    $(".fields.regreso").removeClass("not-allowed");
    $(".file-field").removeClass("not-visible");
    $("#submit-btn").removeClass("not-visible");
    $("#submit-pay-btn").removeClass("not-visible");

    $(".fields.regreso").removeClass("not-allowed");
    $("#pay-msg").addClass("not-visible");
    $("#pay-msg").text("");

    disableFormFielfds(false);
    $(".ui.form").form("clear");
  }

  function formValidation() {
    $.fn.form.settings.rules.file = function(value) {
      if ($('input[name="doc_file"]').hasClass("not-visible")) {
        return true;
      }
      return false;
    };
    $(".ui.form").form({
      inline: true,
      on: "blur",
      transition: "fade down",
      onSuccess: validationpassed,
      fields: {
        nombres: {
          identifier: "nombres",
          rules: [
            {
              type: "empty",
              prompt: "Por favor ingrese un nombre"
            }
          ]
        },
        apellidos: {
          identifier: "apellidos",
          rules: [
            {
              type: "empty",
              prompt: "Por favor ingrese un apellido"
            }
          ]
        },
        dependencia: {
          identifier: "dependencia",
          rules: [
            {
              type: "empty",
              prompt: "Por favor ingrese un nombre"
            }
          ]
        },
        cedula: {
          identifier: "cedula",
          rules: [
            {
              type: "number",
              prompt: "Por favor ingrese una cedula valido"
            },
            {
              type: "empty",
              prompt: "Por favor ingrese una cedula"
            }
          ]
        },
        telefono: {
          identifier: "telefono",
          rules: [
            {
              type: "number",
              prompt: "Por favor ingrese un numero valido"
            },
            {
              type: "empty",
              prompt: "Por favor ingrese un numero"
            }
          ]
        },
        concepto_pago: {
          identifier: "concepto_pago",
          rules: [
            {
              type: "number",
              prompt: "Por favor ingrese un numero valido"
            },
            {
              type: "empty",
              prompt: "Por favor ingrese un numero"
            }
          ]
        },
        pago_total: {
          identifier: "pago_total",
          rules: [
            {
              type: "number",
              prompt: "Por favor ingrese un numero valido"
            },
            {
              type: "empty",
              prompt: "Por favor ingrese un numero"
            }
          ]
        },
        email: {
          identifier: "correo",
          rules: [
            {
              type: "email",
              prompt: "Por favor ingrese a correo valido"
            },
            {
              type: "empty",
              prompt: "Por favor ingrese un correo"
            }
          ]
        },
        doc_file: {
          identifier: "doc_file",
          rules: [
            {
              type: "file",
              prompt: "Por favor ingrese un archivo"
            }
          ]
        }
      }
    });
  }
</script>
